<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Behavior-Action Vision</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      background:#111;
      color:#eee;
      text-align:center;
      padding:30px;
    }
    .wrap{
      max-width:900px;
      margin:0 auto;
    }
    h1{ margin: 0 0 10px; }
    .controls{
      margin: 15px 0 20px;
    }
    input, button{
      font-size:16px;
      margin:10px;
      padding:10px 14px;
    }
    button{
      cursor:pointer;
      border:0;
      border-radius:8px;
      background:#eee;
      color:#111;
      font-weight:600;
    }
    button:hover{ opacity:0.9; }
    img{
      max-width: 820px;
      width: 100%;
      margin-top: 15px;
      border: 2px solid #333;
      border-radius: 10px;
      background:#000;
    }
    .panel{
      margin: 20px auto;
      max-width: 820px;
      text-align:left;
      background:#1b1b1b;
      border-radius:10px;
      padding:15px;
      overflow:auto;
      border:1px solid #2a2a2a;
    }
    .sliderbox{
      margin: 20px auto;
      max-width: 520px;
      background:#1b1b1b;
      border:1px solid #2a2a2a;
      border-radius:10px;
      padding:15px;
    }
    .sliderbox label{
      display:block;
      margin-bottom:10px;
      font-weight:700;
    }
    #thresholdValue{
      font-weight:700;
    }
    .small{
      color:#bbb;
      font-size: 13px;
      margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>游 Behavior-Action Vision</h1>

    <div class="controls">
      <input type="file" id="fileInput" accept="image/*" />
      <br/>
      <button id="btnReference">游늷 Setear referencia</button>
      <button id="btnAnalyze">游댍 Analizar comportamiento</button>
    </div>

    <div class="sliderbox">
      <label for="threshold">Sensibilidad de detecci칩n</label>
      <input type="range" id="threshold" min="0.05" max="0.80" step="0.01" value="0.25" style="width:100%;">
      <div>Threshold: <span id="thresholdValue">0.25</span></div>
      <div class="small">M치s bajo = m치s sensible (m치s alertas). M치s alto = menos sensible.</div>
    </div>

    <img id="preview" style="display:none" />

    <h2>Resultado</h2>
    <div class="panel"><pre id="result">Sin datos</pre></div>
  </div>

<script>
  const fileInput = document.getElementById("fileInput");
  const preview = document.getElementById("preview");
  const resultEl = document.getElementById("result");
  const btnReference = document.getElementById("btnReference");
  const btnAnalyze = document.getElementById("btnAnalyze");
  const threshold = document.getElementById("threshold");
  const thresholdValue = document.getElementById("thresholdValue");

  threshold.addEventListener("input", () => {
    thresholdValue.textContent = Number(threshold.value).toFixed(2);
  });

  fileInput.addEventListener("change", () => {
    const f = fileInput.files[0];
    if (!f) {
      preview.style.display = "none";
      return;
    }
    preview.src = URL.createObjectURL(f);
    preview.style.display = "block";
  });

  function setResult(obj){
    resultEl.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  async function postImage(endpoint){
    const f = fileInput.files[0];
    if (!f) {
      setResult({ok:false, error:"Seleccion치 una imagen primero"});
      return;
    }

    const fd = new FormData();
    // IMPORTANTE: el backend espera "image"
    fd.append("image", f);

    // threshold solo para analyze
    if (endpoint === "/analyze") {
      fd.append("threshold", threshold.value);
    }

    const r = await fetch(endpoint, { method: "POST", body: fd });
    const text = await r.text();

    // Intentar parse JSON; si falla, mostrar texto
    try {
      const data = JSON.parse(text);
      setResult(data);
    } catch (e) {
      setResult("Respuesta no JSON:\n" + text);
    }
  }

  btnReference.addEventListener("click", () => postImage("/reference"));
  btnAnalyze.addEventListener("click", () => postImage("/analyze"));
</script>
</body>
</html>
